Before we create a ECS service to the backend task we need to consider the security and connectivity setting for backend task. I have spent quite a lot of time to understand this part and get things done without problem.

First, as we mentioned in previous tutorial that Security Group is essential to define access privilege for each of the AWS service we are going to use. Let's add each of them below and explain why they are needed.

Navigate to **EC2 --> Security Groups --> Create security group**. To run our backend application, we need it to allow access from frontend. We also need it to access database, pull image from ECR registry and read secret from Secrets Manager. Create group for backend:

>Security group nameï¼š BACKEND_SG
>
>Description: security setting for ECS backend service

Add one inbound rule:

>Port range: 8000
>
>Source: 0.0.0.0/0 (Note: this gives access from all IP addresses which is not good. We'll update this part later.)
>
>Description: allow access from frontend

Add two outbound rules:

For accessing database:

>Type: PostgreSQL
>
>Destigation: from the drop-down list, select **DB_SG**, this is the Security Group we defined in previous tutorial for the database server.
>
>Description: allow access to RDS database

For access ECR registry and Secrets Manager:
>Type: HTTPS
>
>Destination: 0.0.0.0/0
>
>Description: allow access to ECR and Secrets Manager

The above Security Group defines the access previlege for the backend service. On the other side, each service that would be used by backend must also has a Security Group.

For ECR:
>Security group name: ECR_SG
>
>Description: Allow access to ECR registry

Add one inbound rule:
>Type: HTTPS
>
>Source: BACKEND_SG
>
>Description: allow access from backend serivce

For Secrets Manager:
>Security group name: SECRETS_SG
>
>Description: allow access to Secrets Manager

Add one inbound rule:
>Type: HTTPS
>
>Source: BACKEND_SG
>
>Description: allow access from backend service

We have enabled logging in backend task definition by using CloudWatch. So need to define a group for it:

>Security group name: CLOUDWATCH_SG
>
>Description: allow access to CloudWatch

Add one inbound rule:
>Type: HTTPS
>
>Source: BACKEND_SG
>
>Description: allow access from backend service


For the ECR registry, Secrets Manager and CloudWatch, these are AWS public services and they can't be accessed from our own VPC. This is because VPC is a private network and it does not have route to the public services. We need to create **endpoints** to these services so they can be accessed from VPC.

Navigate to **VPC --> PrivateLink and Lattice --> Endpoints**. Create these endpoints:

For ECR registry, create three endpoints:

>Name tag: ECR_ENDPOINT
>
>Type: AWS services
>
>Services: search and select **com.amazonaws.ap-northeast-3.ecr.dkr**
>
>VPC: my-vpc
>
>Subnets: select all
>
>Security groups: select **ECR_SG**

>Name tag: ECR_API_ENGPOINT
>
>Type: AWS services
>
>Services: search and select **com.amazonaws.ap-northeast-3.ecr.api**
>
>VPC: my-vpc
>
>Subnets: select all
>
>Security groups: select **ECR_SG**

>Name tag: S3_ENDPOINT
>
>Type: AWS services
>
>Services: search and select **com.amazonaws.ap-northeast-3.s3**, Type is **Gateway**
>
>VPC: my-vpc
>
>Route tables: Select the default route table

For Secrets Manager:

>Name tag: SECRETS_ENDPOINT
>
>Type: AWS services
>
>Services: search and select **com.amazonaws.ap-northeast-3.secretsmanager**
>
>VPC: my-vpc
>
>Subnets: select all
>
>Security groups: select **SECRETS_SG**

For CloudWatch:

>Name tag: CLOUDWATCH_ENDPOINT
>
>Type: AWS services
>
>Services: search and select **com.amazonaws.ap-northeast-3.logs**
>
>VPC: my-vpc
>
>Subnets: select all
>
>Security groups: select **CLOUDWATCH_SG**